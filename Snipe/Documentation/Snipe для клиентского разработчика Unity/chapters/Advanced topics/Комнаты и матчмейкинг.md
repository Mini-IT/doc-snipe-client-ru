#miniit #snipe #multiplayer

## Общая информация

В онлайн играх существует понятие “комнат”, когда несколько игроков одновременно участвуют в общей игровой сессии, в рамках которой могут взаимодействовать друг с другом. В некоторых проектах это активно используется. Комнаты нельзя создавать вручную, это всегда происходит через механизм матчмейкинга, описанный ниже. Комнаты не живут вечно и имеют дополнительные правила для уничтожения кроме имплементированных в проекте. По умолчанию, созданная комната живет 2 минуты после создания, если у нее не менялось состояние. Аналогично, если в комнате нет ни одного живого игрока, она проживет 2 минуты, после чего будет уничтожена автоматически.

Следует понимать, что данные комнаты и данные профилей игроков находятся в разных местах как логически, так и возможно физически. Более того, к комнате одновременно могут подключаться игроки с разными версиями клиента. Что значит, что нельзя просто взять и поменять внутреннюю структуру комнаты и обработку ей событий, не сломав при этом старые клиенты. Принудительное обновление клиента нежелательная операция, поскольку вызывает отвал часть игроков. Поэтому в редких случаях клиенту придется поддерживать часть старой версии игры. На сервере можно только добавлять новые данные в комнату и сообщения, не ломая старый формат.

## Состояние игрока

При использовании механизмов матчмейкинга и комнат в проект вводится понятие “состояние игрока”. В один момент игрок может быть только в одном состоянии. Если клиент получает на некоторые сообщения ответ `errorCode=wrongState`, это значит что в этом состоянии нельзя делать такие запросы. При этом в ответе приходит значение состояния строкой. Возможные состояния игрока:

- `match` - игрок находится в очереди матчмейкинга. он не может вставать в другую очередь и не может подключаться к комнатам через `room.join`
- `room` - игрок находится в комнате. аналогично.

Состояние игрока не сохраняется в его профиле, поэтому разорвав соединение, игрок оказывается в дефолтном состоянии и может вновь встать в очередь, забросив старую игру. Как с этим бороться, описано ниже.

## Матчмейкинг

Чтобы попасть в комнату, в первую очередь нужно отправить запрос на матчмейкинг (поиск подходящих соперников).

`SnipeApi.Matchmaking.Add()`

Матчмейкинг выполняется на сервере. Иногда этот процесс может занимать длительное время. В некоторых играх после разумного периода ожидания стоит отказаться от поиска реального соперника и запустить игру с ботом. При этом сервер нужно уведомить:

`SnipeApi.Matchmaking.Remove()`

Если же соперник нашелся, сервер пришлет сообщение, которое сгенерирует событие `SnipeApi.Matchmaking.Start`. Нужно понимать, что из-за лагов соединения может получиться так, что была нажата кнопка выхода из очереди (или клиент вышел из очереди по локальному таймауту), сообщение `Matchmaking.Remove` было отправлено по мнению клиента, но в этот момент сервер создал новую игру и прислал сообщение о старте.

`SnipeApi.Matchmaking.Start`

здесь содержатся данные, необходимые для входа в комнату.

Комната будет оставаться активной отведенное ей время, даже если клиентское приложение отключится. Поэтому стоит сохранить данные для входа на случай, если игрок по какой-то причине перезапустит приложение. Если комната всё еще будет оставаться активной, в нее можно будет вернуться.

`errorCode=roomUserLocked` на `Matchmaking.Add`

Приходит в случае когда игрок пытается встать в очередь, находясь в комнате. Его можно получить только после разрыва соединения и захода в комнату через `Room.Join`.

`errorCode=roomUserAttachedLocked` на `Matchmaking.Add`

До недавнего момента во всех проектах требовалось сохранять ID комнаты и вызывать после логина `room.join`, чтобы перезайти в нее. Сейчас в стадии тестирования механизм авто-джойна к комнате, который делает это за клиента. В этом случае при попытке начать матчмейкинг можно получить этот код ошибки, это означает какой-то баг на сервере.

## Работа с комнатой

Для входа в комнату нужно вызвать

`SnipeApi.Room.Join()`

для выхода:

`SnipeApi.Room.Leave()`

для отправки какого-то сообщения всем клиентам, присоединившимся к комнате:

`SnipeApi.Room.Broadcast()`

Во время игровой сессии могут происходить различные игровые события. Чтобы уведомить сервер о таком событии используется

`SnipeApi.Room.Event()`

Сервер также может присылать сообщения, которые не обрабатываются в `SnipeApi`.

Как и в случае серверных действий, запросы о событии имеют обертки для каждого из них в проектном модуле `SnipeApi.Room`, которые следят за строгой типизацией аргументов запроса и ответа.