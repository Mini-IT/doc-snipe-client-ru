#miniit #snipe 

## Общая информация

Аккаунт (или профиль) пользователя состоит из его атрибутов, привязок внешних аккаунтов, сведений о платежах и информации о текущем состоянии “логики” (об этом ниже). Для клиента профиль пользователя - это прежде всего его атрибуты. Кроме этого есть внутренние структуры профиля, которые видно в серверном редакторе, но получить их напрямую с клиента нельзя. Как правило, информация, содержащаяся в них, получается и изменяется через то или иное серверное действие.

## Редактирование

Конкретный профиль игрока редактируется через серверный редактор, раздел меню LiveOps/Players. В поиске игроков вводится либо числовой ID профиля, либо один из других возможных IDов (DeviceID, AdvertisingID, Facebook ID и прочая). После перехода внутрь найденного профиля по кнопке редактирования вы увидите атрибуты игрока (в серверном редакторе везде используется термин Player):

![](Snipe/Documentation/Snipe%20для%20клиентского%20разработчика%20Unity/chapters/Серверный%20редактор/assets/pasted%20image%200.png)

Атрибуты любого игрока можно создавать, править и удалять через редактор в реальном времени. Также можно посмотреть или исправить его инвентарь, платежи, привязки внешних аккаунтов и сырые данные - разделы Raw data и Raw logic. Кроме того, в этом разделе можно сделать вызов серверного действия как бы от лица клиента (при условии что клиент в данный момент онлайн). Это используется для дебажных действий, которые выставляют в профиле то или иное состояние.

Раздел Raw logic - состояние серверной логики игрока. Подробнее о ней написано ниже. Также нужно иметь ввиду, что не всё, что касается игрока, доступно здесь. Например, в атрибутах может быть ссылка на клан, в котором состоит игрок. При этом его клановые данные и данные клана хранятся в другом месте и редактировать их нельзя. Часть данных может храниться отдельно от профиля в Редисе, например место в лидерборде или короткое инфо игрока, или какие-то данные, нужные для конкретного проекта. При копировании игрока (особенно с live версии на dev копипастой Raw data/Raw logic) всё это останется в старой бд привязанное к старому профилю и у нового будет отсутствовать или будет сломано.

## Типы атрибутов и права доступа

Возможные типы атрибутов задаются через серверный редактор в соответствующем разделе `Entities/Player/Attribute Types`.
![](Snipe/Documentation/Snipe%20для%20клиентского%20разработчика%20Unity/chapters/Серверный%20редактор/assets/pasted%20image%201.png)

У атрибутов профиля есть уровень доступа на чтение и запись клиентом:

- `internal` - доступен только на сервере
- `private` - доступен только для своего профиля
- `public` - виден всем пользователям (только для чтения, нельзя сделать публично записываемый атрибут)

Если тип атрибута не объявлен в этом списке или закрыт для чтения, то его не будет в `SnipeApi`. Если вы объявляете типы атрибутов самостоятельно, нужно внимательно подумать о правах доступа. Часть проектов не имеет серверных проверок, в них клиент сохраняет весь профиль сам. В этом случае, понятно, потребуются `private` права на запись. Но в проектах с серверными проверками нужно следовать принципу меньшей привилегии - что будет, если атрибут открыт для записи клиентом и его поменяет хакер? Что он при этом поломает? Как это затронет других игроков?

Публичные для чтения атрибуты используются довольно редко, поскольку они создают нагрузку на сервер. Это всегда минимум запрос профиля игрока из БД, а иногда еще и запрос его внутреннего ID по привязке (дай мне уровень моего друга в ФБ, например). Кроме того, поскольку для простоты имплементации это запрос из БД, а профили пишутся не на каждый запрос, то это не является самой свежей информацией, всегда есть какое-то устаревание, минимум минута. Поэтому этот способ рекомендуется использовать только в крайних случаях, когда других вариантов нет.

Частый случай публичных данных - инфо игрока в лидерборде, например уровень и ID аватарки. Это инфо сохраняется и получается отдельно вместе с лидербордом, чтобы не нужно было делать массовые запросы на каждого участника и подробнее о нем написано в разделе лидербордов.

## Получение и правка атрибутов на клиенте

Для получения всех текущих значений атрибутов нужно вызвать

`SnipeApi.UserAttr.GetAll()`

Обычно `GetAll` вызывается сразу после логина, чтобы на клиенте имелось полное представление о текущем состоянии профиля.

Для получения значения какого-то одного атрибута

`SnipeApi.UserAttr.Get()`

Чтобы задать новое значение атрибута

`SnipeApi.UserAttr.Set()`

Чтобы задать несколько новых значений атрибутов

`SnipeApi.UserAttr.SetMulti()`

Другой вариант работы с атрибутами - обьект

`SnipeApi.UserAttr.UserAttributes`

Поля этого объекта имеют сеттеры, которые вызовут соответствующий метод для правки значения атрибута на сервере. Например

`SnipeApi.UserAttr.UserAttributes.coins += 10;`

Прибавит 10 к значению монет и отправит его на сервер. В этом случае запрос `GetAll` все равно должен быть сделан, чтобы заполнить значения в объекте.

В некоторых случаях клиенту нужно выставлять несколько атрибутов сразу после логина. Например, это часто используется для выставления АБ-флагов или АБ-значений, полученных из Remote Config. В этом случае целесообразно использовать вместо N вызовов `SnipeApi.UserAttr.Set()` один вызов `SnipeApi.UserAttr.SetMulti()`. Почему? Дело в том, что из-за сетевых лагов и возможной нестабильности соединения один запрос всегда выполнится быстрее чем N, что значит что быстрее будет получен один ответ и клиент будет респонсивнее.